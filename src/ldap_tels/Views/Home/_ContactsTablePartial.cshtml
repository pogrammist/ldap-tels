@model IEnumerable<ContactViewModel>
@{
    var contacts = Model.ToList();
    bool firstTableRendered = false;

    var divisionGroups = contacts
        .Where(c => !string.IsNullOrWhiteSpace(c.Division))
        .GroupBy(c => c.Division!)
        .ToList();

    var departmentOnlyGroups = contacts
        .Where(c => string.IsNullOrWhiteSpace(c.Division) && !string.IsNullOrWhiteSpace(c.Department))
        .GroupBy(c => c.Department!)
        .ToList();

    var others = contacts
        .Where(c => string.IsNullOrWhiteSpace(c.Division) && string.IsNullOrWhiteSpace(c.Department))
        .ToList();
}

@foreach (var divisionGroup in divisionGroups)
{
    if (firstTableRendered)
    {
        <div class="mb-4"></div>
    }
    <div class="table-responsive table-card" data-division-wrapper="@divisionGroup.Key">
        <table class="table table-striped table-hover contacts-table">
            <colgroup>
                <col style="width:30%" />
                <col style="width:40%" />
                <col style="width:10%" />
                <col style="width:20%" />
            </colgroup>
            <thead>
                <tr>
                    <th colspan="4">
                        <a asp-action="Division" asp-route-division="@divisionGroup.Key" class="fw-bold text-decoration-none">@divisionGroup.Key</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                @{ string? lastDept = null; }
                @foreach (var row in divisionGroup)
                {
                    var rowHasDept = !string.IsNullOrWhiteSpace(row.Department);
                    if (rowHasDept && !string.Equals(lastDept, row.Department, StringComparison.Ordinal))
                    {
                        lastDept = row.Department;
                        <tr class="table-light">
                            <td colspan="4">
                                <a asp-action="Department" asp-route-department="@row.Department" class="text-decoration-none">@row.Department</a>
                            </td>
                        </tr>
                    }
                    <tr>
                        <td>@row.DisplayName</td>
                        <td>
                            <a asp-action="Title" asp-route-title="@row.Title">
                                @row.Title
                            </a>
                        </td>
                        <td>@row.PhoneNumber</td>
                        <td>
                            @if (!string.IsNullOrEmpty(row.Email))
                            {
                                <a href="mailto:@row.Email">@row.Email</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    firstTableRendered = true;
}

@foreach (var deptGroup in departmentOnlyGroups)
{
    if (firstTableRendered)
    {
        <div class="mb-4"></div>
    }
    <div class="table-responsive table-card" data-department-wrapper="@deptGroup.Key">
        <table class="table table-striped table-hover contacts-table">
            <colgroup>
                <col style="width:30%" />
                <col style="width:40%" />
                <col style="width:10%" />
                <col style="width:20%" />
            </colgroup>
            <thead>
                <tr>
                    <th colspan="4">
                        <a asp-action="Department" asp-route-department="@deptGroup.Key" class="text-decoration-none">@deptGroup.Key</a>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in deptGroup)
                {
                    <tr>
                        <td>@row.DisplayName</td>
                        <td>
                            <a asp-action="Title" asp-route-title="@row.Title">
                                @row.Title
                            </a>
                        </td>
                        <td>@row.PhoneNumber</td>
                        <td>
                            @if (!string.IsNullOrEmpty(row.Email))
                            {
                                <a href="mailto:@row.Email">@row.Email</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    firstTableRendered = true;
}

@if (others.Any())
{
    if (firstTableRendered)
    {
        <div class="mb-4"></div>
    }
    <div class="table-responsive table-card" data-none-wrapper="true">
        <table class="table table-striped table-hover contacts-table">
            <colgroup>
                <col style="width:30%" />
                <col style="width:40%" />
                <col style="width:10%" />
                <col style="width:20%" />
            </colgroup>
            <thead>
                <tr>
                    <th colspan="4">Другие</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in others)
                {
                    <tr>
                        <td>@row.DisplayName</td>
                        <td>
                            <a asp-action="Title" asp-route-title="@row.Title">
                                @row.Title
                            </a>
                        </td>
                        <td>@row.PhoneNumber</td>
                        <td>
                            @if (!string.IsNullOrEmpty(row.Email))
                            {
                                <a href="mailto:@row.Email">@row.Email</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}