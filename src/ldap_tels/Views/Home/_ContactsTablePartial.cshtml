@model IEnumerable<ContactViewModel>
@{
    var contacts = Model.ToList();
    int i = 0;
    bool firstTableRendered = false;
    int noneStartIndex = contacts.FindIndex(c => string.IsNullOrWhiteSpace(c.Division) && string.IsNullOrWhiteSpace(c.Department));
}

@while (i < contacts.Count && (noneStartIndex == -1 || i < noneStartIndex))
{
    var contact = contacts[i];
    var hasDivision = !string.IsNullOrWhiteSpace(contact.Division);
    var hasDepartment = !string.IsNullOrWhiteSpace(contact.Department);

    // Отступ между таблицами (кроме первой)
    if (firstTableRendered)
    {
        <div class="mb-4"></div>
    }

    if (hasDivision)
    {
        // Таблица подразделения, внутри — отделы
        string currentDivision = contact.Division!;
        string? currentDepartment = null;
        <div class="table-responsive table-card">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th colspan="4">
                            <a asp-action="Division" asp-route-division="@currentDivision" class="fw-bold text-decoration-none">@currentDivision</a>
                        </th>
                    </tr>
                    <tr>
                        <th>ФИО</th>
                        <th>Должность</th>
                        <th>Телефон</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    @while (i < contacts.Count && string.Equals(contacts[i].Division, currentDivision, StringComparison.Ordinal))
                    {
                        var row = contacts[i];
                        var rowHasDepartment = !string.IsNullOrWhiteSpace(row.Department);
                        if (rowHasDepartment && currentDepartment != row.Department)
                        {
                            currentDepartment = row.Department;
                            <tr class="table-light">
                                <td colspan="4">
                                    <a asp-action="Department" asp-route-department="@row.Department" class="text-decoration-none">@currentDepartment</a>
                                </td>
                            </tr>
                        }

                        <tr>
                            <td>@row.DisplayName</td>
                            <td>
                                <a asp-action="Title" asp-route-title="@row.Title">
                                    @row.Title
                                </a>
                            </td>
                            <td>@row.PhoneNumber</td>
                            <td>
                                @if (!string.IsNullOrEmpty(row.Email))
                                {
                                    <a href="mailto:@row.Email">@row.Email</a>
                                }
                            </td>
                        </tr>
                        i++;
                    }
                </tbody>
            </table>
        </div>
        firstTableRendered = true;
        continue;
    }
    else if (!hasDivision && hasDepartment)
    {
        // Таблица для отдела без подразделения (одна таблица на отдел)
        string currentDepartment = contact.Department!;
        <div class="table-responsive table-card">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th colspan="4">
                            <a asp-action="Department" asp-route-department="@currentDepartment" class="text-decoration-none">@currentDepartment</a>
                        </th>
                    </tr>
                    <tr>
                        <th>ФИО</th>
                        <th>Должность</th>
                        <th>Телефон</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    @while (i < contacts.Count && string.IsNullOrWhiteSpace(contacts[i].Division) && string.Equals(contacts[i].Department, currentDepartment, StringComparison.Ordinal))
                    {
                        var row = contacts[i];
                        <tr>
                            <td>@row.DisplayName</td>
                            <td>
                                <a asp-action="Title" asp-route-title="@row.Title">
                                    @row.Title
                                </a>
                            </td>
                            <td>@row.PhoneNumber</td>
                            <td>
                                @if (!string.IsNullOrEmpty(row.Email))
                                {
                                    <a href="mailto:@row.Email">@row.Email</a>
                                }
                            </td>
                        </tr>
                        i++;
                    }
                </tbody>
            </table>
        </div>
        firstTableRendered = true;
        continue;
    }
    else
    {
        // Если дошли до блока без подразделения и отдела, прерываем цикл — отрисуем его отдельно в конце
        break;
    }
}

@if (noneStartIndex >= 0)
{
    if (firstTableRendered)
    {
        <div class="mb-4"></div>
    }
    <div class="table-responsive table-card">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th colspan="4">Без подразделения и отдела</th>
                </tr>
                <tr>
                    <th>ФИО</th>
                    <th>Должность</th>
                    <th>Телефон</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody>
                @for (var j = noneStartIndex; j < contacts.Count && string.IsNullOrWhiteSpace(contacts[j].Division) && string.IsNullOrWhiteSpace(contacts[j].Department); j++)
                {
                    var row = contacts[j];
                    <tr>
                        <td>@row.DisplayName</td>
                        <td>
                            <a asp-action="Title" asp-route-title="@row.Title">
                                @row.Title
                            </a>
                        </td>
                        <td>@row.PhoneNumber</td>
                        <td>
                            @if (!string.IsNullOrEmpty(row.Email))
                            {
                                <a href="mailto:@row.Email">@row.Email</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}